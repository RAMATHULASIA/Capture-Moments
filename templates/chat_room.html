{% extends "base.html" %}

{% block title %}Chat - {{ booking.event_type }} - Capture Moments{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px 10px 0 0;
    }
    
    .message {
        margin-bottom: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        max-width: 70%;
    }
    
    .message.own {
        background-color: var(--primary-color);
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .message.other {
        background-color: white;
        border: 1px solid #dee2e6;
    }
    
    .message-header {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-bottom: 0.25rem;
    }
    
    .message-text {
        margin: 0;
    }
    
    .chat-input {
        border-radius: 0 0 10px 10px;
        border-top: none;
    }
    
    .typing-indicator {
        font-style: italic;
        color: #6c757d;
        padding: 0.5rem 1rem;
    }
    
    .file-message {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
    }
    
    .file-message i {
        color: #2196f3;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Chat Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4><i class="fas fa-comments"></i> Chat - {{ booking.event_type }}</h4>
                            <p class="mb-0 text-muted">
                                <i class="fas fa-calendar"></i> {{ booking.event_date }} at {{ booking.event_time }}
                                | <i class="fas fa-map-marker-alt"></i> {{ booking.location }}
                            </p>
                        </div>
                        <div>
                            <span class="badge status-{{ booking.booking_status }}">
                                {{ booking.booking_status.title() }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="chat-container">
                        <!-- Messages Area -->
                        <div class="chat-messages" id="chatMessages">
                            {% for message in messages %}
                            <div class="message {% if message.user_id == current_user_id %}own{% else %}other{% endif %}">
                                <div class="message-header">
                                    <strong>{{ message.username }}</strong>
                                    <span class="timestamp">{{ message.timestamp[:19] }}</span>
                                </div>
                                {% if message.message_type == 'file' %}
                                <div class="file-message">
                                    <i class="fas fa-file"></i>
                                    <a href="{{ message.file_url }}" target="_blank">{{ message.file_name }}</a>
                                </div>
                                {% else %}
                                <p class="message-text">{{ message.message_text }}</p>
                                {% endif %}
                            </div>
                            {% endfor %}
                            
                            <!-- Typing Indicator -->
                            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                                <span id="typingUser"></span> is typing...
                            </div>
                        </div>
                        
                        <!-- Message Input -->
                        <div class="chat-input p-3 bg-light">
                            <div class="row g-2">
                                <div class="col">
                                    <input type="text" class="form-control" id="messageInput" 
                                           placeholder="Type your message..." maxlength="500">
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-secondary" id="fileUploadBtn" type="button">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <input type="file" id="fileInput" style="display: none;" 
                                           accept=".jpg,.jpeg,.png,.pdf,.doc,.docx">
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary" id="sendBtn" type="button">
                                        <i class="fas fa-paper-plane"></i> Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script>
    // Initialize Socket.IO
    const socket = io();
    const roomId = '{{ room_id }}';
    const currentUserId = '{{ current_user_id }}';
    const currentUsername = '{{ session.username }}';
    
    // DOM elements
    const messagesContainer = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const fileUploadBtn = document.getElementById('fileUploadBtn');
    const fileInput = document.getElementById('fileInput');
    const typingIndicator = document.getElementById('typingIndicator');
    const typingUser = document.getElementById('typingUser');
    
    let typingTimer;
    let isTyping = false;
    
    // Join room on connection
    socket.on('connect', function() {
        socket.emit('join_room', {room: roomId});
    });
    
    // Handle incoming messages
    socket.on('receive_message', function(data) {
        addMessage(data);
        scrollToBottom();
    });
    
    // Handle status messages
    socket.on('status', function(data) {
        if (data.user_id !== currentUserId) {
            showNotification(data.msg);
        }
    });
    
    // Handle typing indicators
    socket.on('user_typing', function(data) {
        if (data.user_id !== currentUserId) {
            if (data.typing) {
                typingUser.textContent = data.username;
                typingIndicator.style.display = 'block';
            } else {
                typingIndicator.style.display = 'none';
            }
            scrollToBottom();
        }
    });
    
    // Send message
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('send_message', {
                room: roomId,
                message: message,
                type: 'text'
            });
            messageInput.value = '';
            stopTyping();
        }
    }
    
    // Add message to chat
    function addMessage(data) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${data.user_id === currentUserId ? 'own' : 'other'}`;
        
        let messageContent = '';
        if (data.type === 'file') {
            messageContent = `
                <div class="message-header">
                    <strong>${data.username}</strong>
                    <span class="timestamp">${formatTimestamp(data.timestamp)}</span>
                </div>
                <div class="file-message">
                    <i class="fas fa-file"></i>
                    <a href="${data.file_url}" target="_blank">${data.file_name}</a>
                </div>
            `;
        } else {
            messageContent = `
                <div class="message-header">
                    <strong>${data.username}</strong>
                    <span class="timestamp">${formatTimestamp(data.timestamp)}</span>
                </div>
                <p class="message-text">${escapeHtml(data.message)}</p>
            `;
        }
        
        messageDiv.innerHTML = messageContent;
        messagesContainer.appendChild(messageDiv);
    }
    
    // Typing indicators
    function startTyping() {
        if (!isTyping) {
            isTyping = true;
            socket.emit('typing', {room: roomId, typing: true});
        }
        
        clearTimeout(typingTimer);
        typingTimer = setTimeout(stopTyping, 3000);
    }
    
    function stopTyping() {
        if (isTyping) {
            isTyping = false;
            socket.emit('typing', {room: roomId, typing: false});
        }
        clearTimeout(typingTimer);
    }
    
    // File upload
    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        fetch(`/chat/upload-file/${roomId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('File uploaded successfully');
            } else {
                showNotification('File upload failed: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('File upload failed', 'error');
        });
    }
    
    // Utility functions
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleTimeString();
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showNotification(message, type = 'info') {
        // Simple notification - could be enhanced with a proper notification system
        console.log(`${type.toUpperCase()}: ${message}`);
    }
    
    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        } else {
            startTyping();
        }
    });
    
    fileUploadBtn.addEventListener('click', function() {
        fileInput.click();
    });
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadFile(file);
        }
    });
    
    // Initial scroll to bottom
    scrollToBottom();
</script>
{% endblock %}
